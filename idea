#!/usr/bin/env bash

if [ "$1" = "init" ]; then

  if [ -e ".idea" ]; then
    echo ".idea already exists here. Nothing to do."
  else
    touch .idea
    echo "Created .idea in $(pwd)"
  fi

  if [ ! -f "IDEA.md" ]; then
    echo "# Ideas for $(basename "$(pwd)")" > IDEA.md
    echo "Created IDEA.md"
  fi

  if [ ! -f "$HOME/.ideas.log" ]; then
    cd "$HOME" && echo "# ideas log file" > .ideas.log
    echo "$HOME/.ideas.log file created"
  fi

  exit 0
fi

find_project_root() {
  local dir="$PWD"
  while [ "$dir" != "/" ]; do

    if [ -e "$dir/.idea" ]; then
      echo "$dir"
      return 0
    fi
    dir="$(dirname "$dir")"

  done
  return 1 # no .idea found
}

GLOBAL_IDEAS_FILE="$HOME/.ideas.log"

if PROJECT_ROOT="$(find_project_root)"; then
  IDEAS_FILE="$PROJECT_ROOT/IDEA.md"

else 
  IDEAS_FILE="$GLOBAL_IDEAS_FILE"
  echo "No .idea project found. Logging idea to $IDEAS_FILE"
fi

if [ ! -f "$IDEAS_FILE" ]; then
  if [ "$IDEAS_FILE" != "$GLOBAL_IDEAS_FILE" ]; then
    echo "# Ideas for $(basename "$PROJECT_ROOT")"> "$IDEAS_FILE"
  else
    touch "$IDEAS_FILE"
  fi
fi

echo "- $(date '+%Y-%m-%d %H:%M') - $*" >> "$IDEAS_FILE"
echo "Saved idea to $IDEAS_FILE"
